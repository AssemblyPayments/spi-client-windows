# Pipeline will be triggered based if the following are satisfied:
# - Any commits on any branch excluding 'prototype'
# - Tags on any branch
# - All pull requests

pool:
  vmImage: 'windows-latest'

pr:
  branches:
    include:
    - '*'

trigger:
  branches:
    include:
      - '*'
    exclude:
      - 'prototype/*'
  tags:
    include: 
       - '*'

variables:
  
  solution: '**/*.sln'
  buildVersion: '16.0'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

stages:
- stage: build
  displayName: Build
  jobs:
  - job: build
    displayName: Building SPIClient
    steps:
        # restore nuget packages from solution
        - task: NuGetCommand@2
          displayName: Restore nuget solution
          inputs:
            restoreSolution: '$(solution)'

        # build solution
        - task: VSBuild@1
          displayName: Build SPIClient
          inputs:
            solution: '$(solution)'
            vsVersion: '$(buildVersion)'
            platform: '$(buildPlatform)'
            configuration: '$(buildConfiguration)'

        # run visual studio unit tests
        - task: VSTest@2
          displayName: Run VSTests
          inputs:
            platform: '$(buildPlatform)'
            configuration: '$(buildConfiguration)'

        # publish artifact  
        - publish: $(System.DefaultWorkingDirectory)
          artifact: $(ARTIFACT_NAME)
          condition: and(succeeded(), contains('$(Build.SourceBranch)', 'refs/tags/'))      
          displayName: 'Publish Arfifact'

- stage: deploy
  condition: and(succeeded(), contains('$(Build.SourceBranch)', 'refs/tags/'))      
  displayName: Deploy
  dependsOn: build
  jobs:
  - deployment: SPIClient
    displayName: Deploy
    environment: production
    strategy:
      runOnce:
        deploy:
          steps:
          # package SPIClient 
          - task: NuGetCommand@2
            displayName: Package SPIClient
            inputs:
                command: 'pack'
                packagesToPack: '.\SPIClient\SPIClient.csproj'
                configuration: '$(buildConfiguration)'    
          # publish to NuGet
          - task: PublishPipelineArtifact@1
            displayName: Publish SPIClient to NuGet
            inputs:
              artifactName: SPIClient